name: Deploy Agent A

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/agentA_microservice/**'
      - '.github/workflows/deploy-agentA.yml'


jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      ######################################################################
      # 1 — Instalar OpenVPN
      ######################################################################
      - name: Install OpenVPN
        run: |
          sudo apt-get update
          sudo apt-get install -y openvpn
        
      ######################################################################
      # 2 — Criar ficheiros necessários para o túnel VPN
      ######################################################################
      - name: Prepare VPN configuration files
        run: |
          # Credenciais
          echo -e "${{ secrets.VPN_USERNAME }}\n${{ secrets.VPN_PASSWORD }}" > auth.txt
          chmod 600 auth.txt

          # CA
          echo "${{ secrets.VPN_CA }}" > ca.crt
          chmod 600 ca.crt

          # TLS Auth Key
          echo "${{ secrets.VPN_TLS_AUTH }}" > tls.key
          chmod 600 tls.key

          # Criar base .ovpn
          echo "${{ secrets.VPN_CONFIG }}" > vpn.ovpn

          # Ajustar caminhos
          sed -i 's|auth-user-pass|auth-user-pass auth.txt|' vpn.ovpn
          sed -i 's|ca .*|ca ca.crt|' vpn.ovpn
          sed -i 's|tls-auth .*|tls-auth tls.key 1|' vpn.ovpn


      ######################################################################
      # 3 — Ligar à VPN
      ######################################################################
      - name: Connect to VPN
        run: |
          sudo openvpn --config vpn.ovpn --daemon
          echo "Ligando à VPN…"
          sleep 15


      ######################################################################
      # 4 — (IMPORTANTE) Corrigir rotas rejeitadas pelo GitHub runner
      ######################################################################
      - name: Fix VPN Routes
        run: |
          echo "Adicionar rota estática manual para 10.255.0.0/16"
          sudo ip route add 10.255.0.0/16 via 172.16.10.1 dev tun0 || true
          echo "--- Rotas atuais ---"
          ip route


      ######################################################################
      # 5 — Testar conectividade com a VM
      ######################################################################
      - name: Ping VM
        run: |
          echo "A testar ping a 10.255.32.134…"
          ping -c 4 10.255.32.134 || echo "VM não respondeu — verificar firewall"



      ######################################################################
      # 4 — Setup SSH (apenas quando VPN está ativa)
      ######################################################################
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Configuração explícita no SSH config
          cat >> ~/.ssh/config << EOF
          Host agenta-vm
            HostName ${{ secrets.AGENTA }}
            User ${{ secrets.VM_USERNAME }}
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
          EOF

          # Testar
          ssh agenta-vm "echo '✅ Conectado!'"

      ######################################################################
      # 5 — Configurar Docker Context remoto
      ######################################################################
      - name: Configure Docker context
        run: |
          docker context create agentA --docker "host=ssh://${{ secrets.VM_USERNAME }}@${{ secrets.AGENTA }}"
          docker context use agentA

      ######################################################################
      # 6 — Build + Deploy na VM
      ######################################################################
      - name: Build and Deploy Agent A
        run: |
          docker build -t agentA:latest -f src/agentA_microservice/Dockerfile .
          docker stop agentA || true
          docker rm agentA || true
          docker run -d --name agentA agentA:latest

          echo "Deploy concluído com sucesso ✔️"
