name: Deploy Agent A

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/agentA_microservice/**'
      - '.github/workflows/deploy-agentA.yml'


jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      ######################################################################
      # 1 — Instalar OpenVPN
      ######################################################################
      - name: Install OpenVPN
        run: |
          sudo apt-get update
          sudo apt-get install -y openvpn
        
      ######################################################################
      # 2 — Criar ficheiros necessários para o túnel VPN
      ######################################################################
      - name: Prepare VPN configuration files
        run: |
          # Credenciais
          echo -e "${{ secrets.VPN_USERNAME }}\n${{ secrets.VPN_PASSWORD }}" > auth.txt
          chmod 600 auth.txt

          # CA
          echo "${{ secrets.VPN_CA }}" > ca.crt
          chmod 600 ca.crt

          # TLS Auth Key (inclui comentários e headers)
          echo "${{ secrets.VPN_TLS_AUTH }}" > tls.key
          chmod 600 tls.key

          # Criar .ovpn base
          echo "${{ secrets.VPN_CONFIG }}" > vpn.ovpn


      ######################################################################
      # 3 — Ligar à VPN (com logs)
      ######################################################################
      - name: Connect to VPN
        run: |
          sudo openvpn --config vpn.ovpn --verb 4 --daemon
          sleep 15

          echo "--- OpenVPN Log (últimos 50s) ---"
          sudo grep openvpn /var/log/syslog | tail -n 50 || true

          echo "--- Interfaces ---"
          ip addr

          echo "--- Rotas ---"
          ip route

          echo "--- Teste ping VM ---"
          ping -c 3 ${{ secrets.AGENTA }} || echo "VM ainda não responde"

      
      ######################################################################
      # (IMPORTANTE) Corrigir rotas rejeitadas pelo GitHub runner
      ######################################################################
      - name: Fix VPN Routes
        run: |
          echo "Adicionar rota estática manual para 10.255.0.0/16"
          sudo ip route add 10.255.0.0/16 via 172.16.10.1 dev tun0 || true
          echo "--- Rotas atuais ---"
          ip route


      ######################################################################
      # 4 — Setup SSH (apenas quando VPN está ativa)
      ######################################################################
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Configuração explícita no SSH config
          cat >> ~/.ssh/config << EOF
          Host agenta-vm
            HostName ${{ secrets.AGENTA }}
            User ${{ secrets.VM_USERNAME }}
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
          EOF

          # Testar
          ssh agenta-vm "echo '✅ Conectado!'"

      ######################################################################
      # 5 — Configurar Docker Context remoto
      ######################################################################
      - name: Configure Docker context
        run: |
          docker context create agentA --docker "host=ssh://${{ secrets.VM_USERNAME }}@${{ secrets.AGENTA }}"
          docker context use agentA

      ######################################################################
      # 6 — Build + Deploy na VM
      ######################################################################
      - name: Build and Deploy Agent A
        run: |
          docker build -t agentA:latest -f src/agentA_microservice/Dockerfile .
          docker stop agentA || true
          docker rm agentA || true
          docker run -d --name agentA agentA:latest

          echo "Deploy concluído com sucesso ✔️"
