name: Deploy Agent A

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/agentA_microservice/**'
      - '.github/workflows/deploy-agentA.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker context for Agent A
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AGENTA }} >> ~/.ssh/known_hosts
          
          # Criar e usar Docker context para Agent A
          docker context create agentA --docker "host=ssh://${{ secrets.VM_USERNAME }}@${{ secrets.AGENTA }}"
          docker context use agentA

      - name: Build and deploy Agent A
        run: |
          # Build da imagem diretamente na VM
          docker build -t agentA:latest -f src/agentA_microservice/Dockerfile .
          
          # Deploy na VM usando Docker context
          docker run -d agentA:latest
          
          echo 'Agent A deployed successfully'
          