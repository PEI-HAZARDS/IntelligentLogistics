name: Deploy Agent A

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/agentA_microservice/**'
      - '.github/workflows/deploy-agentA.yml'


jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      ######################################################################
      # 1 ‚Äî Instalar OpenVPN
      ######################################################################
      - name: Install OpenVPN
        run: |
          sudo apt-get update
          sudo apt-get install -y openvpn openvpn-systemd-resolved net-tools dnsmasq
        
      
      ######################################################################
      # 2 ‚Äî Criar ficheiros necess√°rios para o t√∫nel VPN
      ######################################################################
      - name: Prepare VPN configuration files
        run: |
          mkdir -p vpn_config
          
          # Credenciais
          echo "${{ secrets.VPN_USERNAME }}" > vpn_config/auth.txt
          echo "${{ secrets.VPN_PASSWORD }}" >> vpn_config/auth.txt
          chmod 600 vpn_config/auth.txt

          # CA
          echo "${{ secrets.VPN_CA }}" > vpn_config/ca.crt
          chmod 600 vpn_config/ca.crt

          # TLS Auth Key
          echo "${{ secrets.VPN_TLS_AUTH }}" > vpn_config/tls.key
          chmod 600 vpn_config/tls.key

          # Guardar .ovpn do secret
          echo "${{ secrets.VPN_CONFIG }}" > vpn_config/vpn.ovpn
          
          chmod 600 vpn_config/vpn.ovpn

      
      ######################################################################
      # 3 ‚Äî Ligar √† VPN
      ######################################################################
      - name: Connect to VPN
        run: |
          cd vpn_config
          
          # Tentar com sudo e sem scripts problem√°ticos
          sudo openvpn --config vpn.ovpn --verb 4 --daemon --log /tmp/openvpn.log --script-security 0
          
          # Aguardar conex√£o
          for i in {1..30}; do
            if ip addr show tun0 > /dev/null 2>&1; then
              echo "‚úÖ VPN conectada na tentativa $i"
              break
            fi
            echo "Aguardando VPN... ($i/30)"
            sleep 2
          done
          
          # For√ßar DNS manualmente
          echo "Configurando DNS..."
          echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf > /dev/null
          echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf > /dev/null
          
          # Verifica√ß√µes
          echo "--- Status VPN ---"
          ip addr show tun0 || echo "‚ö†Ô∏è  Interface tun0 n√£o encontrada"
          
          echo "--- Rotas ---"
          ip route | head -20
          
          echo "--- Log OpenVPN ---"
          sudo tail -n 50 /tmp/openvpn.log
          
          echo "--- Teste DNS ---"
          nslookup temp-pfsense.av.it.pt || echo "‚ö†Ô∏è  DNS falhou (esperado em CI)"
          
          echo "--- Teste ping ---"
          ping -c 3 ${{ secrets.AGENTA }} || echo "‚ö†Ô∏è  Ping falhou"

      ######################################################################
      # 3.5 ‚Äî Test connectivity
      ######################################################################
      - name: Test connectivity to Agent A VM
        run: |
          TARGET_IP="${{ secrets.AGENTA }}"
          echo "üîç Testando conectividade a $TARGET_IP..."
          
          # Aguardar um pouco mais
          sleep 5
          
          echo "--- VPN Status ---"
          ip addr show tun0 || echo "‚ö†Ô∏è  tun0 n√£o existe"
          ip route | grep $TARGET_IP || echo "‚ö†Ô∏è  Sem rota para $TARGET_IP"
          
          echo "--- Ping (tentativa 1) ---"
          ping -c 5 $TARGET_IP && echo "‚úÖ Ping OK" || echo "‚ùå Ping falhou"
          
          echo "--- Ping (tentativa 2 - com mais paci√™ncia) ---"
          for i in {1..3}; do
            echo "Tentativa $i..."
            ping -c 2 -W 5 $TARGET_IP && echo "‚úÖ Ping OK na tentativa $i" && break
            sleep 2
          done
          
          echo "--- SSH Port ---"
          timeout 10 bash -c "cat < /dev/null > /dev/tcp/$TARGET_IP/22" && echo "‚úÖ SSH port (22) aberto" || echo "‚ùå SSH port fechado"



      ######################################################################
      # 4 ‚Äî Setup SSH
      ######################################################################
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # SSH config
          cat > ~/.ssh/config << EOF
          Host agenta-vm
            HostName ${{ secrets.AGENTA }}
            User ${{ secrets.VM_USERNAME }}
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            ConnectTimeout 10
            ServerAliveInterval 60
            ServerAliveCountMax 3
          EOF
          
          chmod 600 ~/.ssh/config
          
          # Debug
          echo "--- SSH Test ---"
          ssh -vvv agenta-vm "echo '‚úÖ SSH Conectado!'" || {
            echo "SSH falhou!"
            exit 1
          }


      ######################################################################
      # 4 ‚Äî Setup SSH (apenas quando VPN est√° ativa)
      ######################################################################
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Configura√ß√£o expl√≠cita no SSH config
          cat >> ~/.ssh/config << EOF
          Host agenta-vm
            HostName ${{ secrets.AGENTA }}
            User ${{ secrets.VM_USERNAME }}
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
          EOF

          # Testar
          ssh agenta-vm "echo '‚úÖ Conectado!'"

      ######################################################################
      # 5 ‚Äî Configurar Docker Context remoto
      ######################################################################
      - name: Configure Docker context
        run: |
          docker context create agentA --docker "host=ssh://${{ secrets.VM_USERNAME }}@${{ secrets.AGENTA }}"
          docker context use agentA

      ######################################################################
      # 6 ‚Äî Build + Deploy na VM
      ######################################################################
      - name: Build and Deploy Agent A
        run: |
          docker build -t agentA:latest -f src/agentA_microservice/Dockerfile .
          docker stop agentA || true
          docker rm agentA || true
          docker run -d --name agentA agentA:latest

          echo "Deploy conclu√≠do com sucesso ‚úîÔ∏è"
