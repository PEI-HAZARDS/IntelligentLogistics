name: Deploy Agent A

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/agentA_microservice/**'
      - '.github/workflows/deploy-agentA.yml'


jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      ######################################################################
      # 1 — Instalar OpenVPN
      ######################################################################
      - name: Install OpenVPN
        run: |
          sudo apt-get update
          sudo apt-get install -y openvpn
        
      
      ######################################################################
      # 2 — Criar ficheiros necessários para o túnel VPN
      ######################################################################
      - name: Prepare VPN configuration files
        run: |
          mkdir -p vpn_config
          
          # Credenciais
          echo "${{ secrets.VPN_USERNAME }}" > vpn_config/auth.txt
          echo "${{ secrets.VPN_PASSWORD }}" >> vpn_config/auth.txt
          chmod 600 vpn_config/auth.txt

          # CA
          echo "${{ secrets.VPN_CA }}" > vpn_config/ca.crt
          chmod 600 vpn_config/ca.crt

          # TLS Auth Key
          echo "${{ secrets.VPN_TLS_AUTH }}" > vpn_config/tls.key
          chmod 600 vpn_config/tls.key

          # Guardar .ovpn do secret
          echo "${{ secrets.VPN_CONFIG }}" > vpn_config/vpn.ovpn
          
          chmod 600 vpn_config/vpn.ovpn

      ######################################################################
      # 3 — Ligar à VPN
      ######################################################################
      - name: Connect to VPN
        run: |
          cd vpn_config
          sudo openvpn --config vpn.ovpn --verb 4 --daemon --log /tmp/openvpn.log
          
          # Aguardar conexão
          for i in {1..30}; do
            if ip addr show tun0 > /dev/null 2>&1; then
              echo "✅ VPN conectada na tentativa $i"
              break
            fi
            echo "Aguardando VPN... ($i/30)"
            sleep 2
          done
          
          # Verificações
          echo "--- Status VPN ---"
          ip addr show tun0 || echo "⚠️  Interface tun0 não encontrada"
          
          echo "--- Rotas ---"
          ip route | grep tun0 || echo "⚠️  Nenhuma rota para tun0"
          
          echo "--- Log OpenVPN ---"
          sudo tail -n 50 /tmp/openvpn.log
          
          echo "--- Teste DNS ---"
          nslookup temp-pfsense.av.it.pt || echo "⚠️  DNS falhou"



      ######################################################################
      # 4 — Setup SSH (apenas quando VPN está ativa)
      ######################################################################
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Configuração explícita no SSH config
          cat >> ~/.ssh/config << EOF
          Host agenta-vm
            HostName ${{ secrets.AGENTA }}
            User ${{ secrets.VM_USERNAME }}
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
          EOF

          # Testar
          ssh agenta-vm "echo '✅ Conectado!'"

      ######################################################################
      # 5 — Configurar Docker Context remoto
      ######################################################################
      - name: Configure Docker context
        run: |
          docker context create agentA --docker "host=ssh://${{ secrets.VM_USERNAME }}@${{ secrets.AGENTA }}"
          docker context use agentA

      ######################################################################
      # 6 — Build + Deploy na VM
      ######################################################################
      - name: Build and Deploy Agent A
        run: |
          docker build -t agentA:latest -f src/agentA_microservice/Dockerfile .
          docker stop agentA || true
          docker rm agentA || true
          docker run -d --name agentA agentA:latest

          echo "Deploy concluído com sucesso ✔️"
