name: Deploy Agent B

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/agentB_microservice/**'
      - '.github/workflows/deploy-agentB.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker context for Agent B
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AGENTB }} >> ~/.ssh/known_hosts
          
          # Criar e usar Docker context para Agent B
          docker context create agentB --docker "host=ssh://${{ secrets.VM_USERNAME }}@${{ secrets.AGENTB }}"
          docker context use agentB

      - name: Build and deploy Agent B
        run: |
          # Build da imagem diretamente na VM
          docker build -t agentB:latest -f src/agentB_microservice/Dockerfile .
          
          # Deploy na VM usando Docker context
          docker run -d agentB:latest
          
          echo 'Agent B deployed successfully'