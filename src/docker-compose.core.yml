# Core Services Group Deployment (API Gateway, Data Module, Decision Engine)
# Usage: docker-compose -f docker-compose.core.yml up -d
# Requires: Network 'intelligent-logistics' must exist (run infra first)

services:
  data-module:
    build: ./Data_Module
    container_name: dm_data_module
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - DATABASE_URL=${DATABASE_URL}
      - MONGO_URL=${MONGO_URL}
      - MONGO_HOST=${MONGO_HOST}
      - MONGO_PORT=${MONGO_PORT}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - DECISION_ENGINE_URL=${DECISION_ENGINE_URL}
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT}
      - DEBUG=${DEBUG}
      - DEBUG_MODE=${DEBUG_MODE}
      - TOKEN_EXPIRY_HOURS=${TOKEN_EXPIRY_HOURS}
      - API_PREFIX=${API_PREFIX}
    ports:
      - "8080:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - intelligent-logistics

  api-gateway:
    build: ./api_gateway
    container_name: api_gateway
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - DATA_MODULE_URL=${DATA_MODULE_URL}
      - STREAM_BASE_URL=${STREAM_BASE_URL}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS}
      - KAFKA_DECISION_TOPIC=${KAFKA_DECISION_TOPIC}
      - KAFKA_CONSUMER_GROUP=${KAFKA_CONSUMER_GROUP}
      - API_PREFIX=${API_PREFIX}
      - ENV=${ENV}
      - CORS_ALLOW_ORIGINS=${CORS_ALLOW_ORIGINS}
      - CORS_ALLOW_CREDENTIALS=${CORS_ALLOW_CREDENTIALS}
      - CORS_ALLOW_METHODS=${CORS_ALLOW_METHODS}
      - CORS_ALLOW_HEADERS=${CORS_ALLOW_HEADERS}
    networks:
      - intelligent-logistics

  decision-engine:
    build: ./decision_engine_microservice
    container_name: decision-engine
    restart: unless-stopped
    environment:
      - PYTHONPATH=/app
      - KAFKA_BOOTSTRAP=${KAFKA_BOOTSTRAP}
      - GATE_ID=${GATE_ID}
      - API_URL=${API_URL}
      - TIME_TOLERANCE_MINUTES=${TIME_TOLERANCE_MINUTES}
    networks:
      - intelligent-logistics

networks:
  intelligent-logistics:
    external: true
