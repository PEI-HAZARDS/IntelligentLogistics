services:
  nginx-rtmp:
    build: .
    container_name: nginx-rtmp
    ports:
      - "1935:1935"  # RTMP - EXPOSTO para rede externa
      - "8080:8080"  # HTTP/HLS - EXPOSTO para frontend
    environment:
      # Stream Mode: "camera" (default) ou "test"
      - STREAM_MODE=${STREAM_MODE}
      # Configuração da câmara (usado quando STREAM_MODE=camera)
      - CAMERA_IP=${CAMERA_IP}
      - RTSP_PORT=${RTSP_PORT}
      - STREAM_LOW_PATH=${STREAM_LOW_PATH}
      - STREAM_HIGH_PATH=${STREAM_HIGH_PATH}
      - GATE_ID=${GATE_ID}
      # Configuração do vídeo de teste (usado quando STREAM_MODE=test)
      - TEST_VIDEO_PATH=${TEST_VIDEO_PATH}
    volumes:
      # Caminho absoluto na VM para os vídeos de teste
      - ${TEST_VIDEOS_HOST_PATH}:/videos:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
