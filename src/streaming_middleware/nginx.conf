worker_processes auto;
rtmp_auto_push on;

events {
    worker_connections 1024;
}

# ============================================
# MÓDULO RTMP
# ============================================
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        
        # ----------------------------------------
        # Aplicação LOW (720p) - Always-on
        # FFmpeg ingest publica aqui: rtmp://localhost/live_low/gate01
        # ----------------------------------------
        application live_low {
            live on;
            record off;
            
            # Permitir publish apenas do FFmpeg ingest (localhost)
            allow publish 127.0.0.1;
            deny publish all;
            
            # Permitir qualquer um consumir (Agents)
            allow play all;
            
            # Re-publica para buffer interno (para múltiplos consumidores)
            push rtmp://localhost/streams_low/gate01;
            
            # Gera HLS para frontend
            hls on;
            hls_path /tmp/hls/low;
            hls_fragment 2s;            # Fragmentos de 2s
            hls_playlist_length 10s;    # Playlist com últimos 10s
            hls_cleanup on;             # Remove fragmentos antigos
            
            # Gera DASH (opcional, para navegadores que não suportam HLS)
            dash on;
            dash_path /tmp/dash/low;
            dash_fragment 2s;
            dash_cleanup on;
        }
        
        # ----------------------------------------
        # Aplicação HIGH (4K) - Always-on
        # FFmpeg ingest publica aqui: rtmp://localhost/live_high/gate01
        # Agent-B/C consomem quando Kafka envia evento truck-detected
        # ----------------------------------------
        application live_high {
            live on;
            record off;
            
            # Permitir publish apenas do FFmpeg ingest
            allow publish 127.0.0.1;
            deny publish all;
            
            # Permitir play para todos
            allow play all;
            
            # Re-publica para buffer interno
            push rtmp://localhost/streams_high/gate01;
            
            # Gera HLS
            hls on;
            hls_path /tmp/hls/high;
            hls_fragment 2s;
            hls_playlist_length 10s;
            hls_cleanup on;
            
            # DASH opcional
            dash on;
            dash_path /tmp/dash/high;
            dash_fragment 2s;
            dash_cleanup on;
        }
        
        # ----------------------------------------
        # Buffer Interno LOW (para distribuição)
        # Agents consomem: rtmp://nginx-rtmp/streams_low/gate01
        # ----------------------------------------
        application streams_low {
            live on;
            record off;
            
            # Apenas localhost pode publicar (vem do push acima)
            allow publish 127.0.0.1;
            deny publish all;
            
            # Qualquer um pode consumir (Agent-A, etc)
            allow play all;
        }
        
        # ----------------------------------------
        # Buffer Interno HIGH (para distribuição)
        # Agents consomem: rtmp://nginx-rtmp/streams_high/gate01
        # ----------------------------------------
        application streams_high {
            live on;
            record off;
            
            # Apenas localhost pode publicar
            allow publish 127.0.0.1;
            deny publish all;
            
            # Qualquer um pode consumir (Agent-B/C quando ativados)
            allow play all;
        }
    }
}

# ============================================
# MÓDULO HTTP (Servir HLS/DASH para Frontend)
# ============================================
http {
    server {
        listen 8080;
        
        # CORS para permitir frontend consumir de domínio diferente
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Range' always;
        
        # ----------------------------------------
        # Servir HLS LOW (720p)
        # URL: http://nginx-rtmp:8080/hls/low/gate01.m3u8
        # ----------------------------------------
        location /hls/low {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /tmp;
            add_header Cache-Control no-cache;
            
            # Permitir range requests (seek no vídeo)
            add_header Accept-Ranges bytes;
        }
        
        # ----------------------------------------
        # Servir HLS HIGH (4K)
        # URL: http://nginx-rtmp:8080/hls/high/gate01.m3u8
        # ----------------------------------------
        location /hls/high {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /tmp;
            add_header Cache-Control no-cache;
            add_header Accept-Ranges bytes;
        }
        
        # ----------------------------------------
        # Servir DASH (opcional, alternativa ao HLS)
        # URL: http://nginx-rtmp:8080/dash/low/gate01.mpd
        # ----------------------------------------
        location /dash {
            types {
                application/dash+xml mpd;
                video/mp4 mp4;
                video/mp2t ts;
            }
            root /tmp;
            add_header Cache-Control no-cache;
        }
        
        # ----------------------------------------
        # Estatísticas do Nginx RTMP (útil para debug)
        # URL: http://nginx-rtmp:8080/stat
        # Mostra: streams ativos, bitrate, viewers, etc.
        # ----------------------------------------
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }
        
        location /stat.xsl {
            root /usr/local/nginx/html;
        }
        
        # ----------------------------------------
        # Health Check (para monitorização)
        # URL: http://nginx-rtmp:8080/health
        # Usado por: Docker healthcheck, Kubernetes probes, Monitoring
        # ----------------------------------------
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
    }
}