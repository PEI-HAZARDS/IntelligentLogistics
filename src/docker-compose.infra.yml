# Infrastructure Group Deployment (Databases, Storage, Streaming)
# Usage: docker-compose -f docker-compose.infra.yml up -d

services:
  postgres:
    image: postgres:15
    container_name: dm_postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - intelligent-logistics

  mongo:
    image: mongo:6
    container_name: dm_mongo
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
    ports:
      - "${MONGO_PORT}:27017"
    volumes:
      - mongodata:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - intelligent-logistics

  redis:
    image: redis:7
    container_name: dm_redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - intelligent-logistics

  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "${MINIO_API_PORT}:9000"
      - "${MINIO_CONSOLE_PORT}:9090"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - miniodata:/data
    command: server /data --console-address ":9090"
    restart: unless-stopped
    networks:
      - intelligent-logistics

  nginx-rtmp:
    build: ./streaming_middleware
    container_name: nginx-rtmp
    ports:
      - "1935:1935"
      - "8081:8080"
    environment:
      - STREAM_MODE=${STREAM_MODE}
      - CAMERA_IP=${CAMERA_IP}
      - RTSP_PORT=${RTSP_PORT}
      - STREAM_LOW_PATH=${STREAM_LOW_PATH}
      - STREAM_HIGH_PATH=${STREAM_HIGH_PATH}
      - GATE_ID=${GATE_ID}
      - TEST_VIDEO_PATH=${TEST_VIDEO_PATH}
    volumes:
      - ${TEST_VIDEOS_HOST_PATH}:/videos:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - intelligent-logistics

volumes:
  pgdata:
  mongodata:
  miniodata:

networks:
  intelligent-logistics:
    driver: bridge
